<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Job</title>
    <!-- Load the static files -->
    {% load static %}
    <link href="{% static 'css/styles.css' %}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Custom Styles for Form Layout */
        .form-container {
            background-color: #f8f9fa;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        .form-heading {
            font-size: 1.5rem;
            color: #343a40;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: bold;
        }

        .btn-custom {
            background-color: #28a745;
            color: white;
            font-size: 16px;
            border-radius: 5px;
        }

        .btn-custom:hover {
            background-color: #218838;
        }

        input[readonly], textarea[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="form-container">
        <h2 class="form-heading text-center">Create New Job</h2>

        <form method="post" id="jobForm">
            {% csrf_token %}

            <!-- JC# (Job Code) Field -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="id_job_name" class="form-label">JC#</label>
                    <input type="text" id="id_job_name" class="form-control" readonly>  <!-- Keep readonly here to prevent manual edits -->
                    <input type="hidden" name="job_name" id="hidden_job_name"> <!-- Hidden input to store JC# -->
                </div>
            </div>

            <!-- SKU Field -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="id_sku" class="form-label">SKU</label>
                    {{ form.sku }}
                </div>
                <div class="col-md-6">
                    <label for="id_sku_code" class="form-label">SKU Code</label>
                    {{ form.sku_code }}
                </div>
            </div>

            <!-- Read-only Fields (will be populated automatically) -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="id_material_type" class="form-label">Material Type</label>
                    {{ form.material_type }}
                </div>
                <div class="col-md-6">
                    <label for="id_application_type" class="form-label">Application Type</label>
                    {{ form.application_type }}
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="id_one_up_width" class="form-label">One-up Width</label>
                    {{ form.one_up_width }}
                </div>
                <div class="col-md-6">
                    <label for="id_one_up_height" class="form-label">One-up Height</label>
                    {{ form.one_up_height }}
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="id_print_sheet_width" class="form-label">Print Sheet Width</label>
                    {{ form.print_sheet_width }}
                </div>
                <div class="col-md-6">
                    <label for="id_print_sheet_height" class="form-label">Print Sheet Height</label>
                    {{ form.print_sheet_height }}
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="id_print_sheet_size" class="form-label">Print Sheet Size</label>
                    {{ form.print_sheet_size }}
                </div>
                <div class="col-md-6">
                    <label for="id_ups" class="form-label">UPS</label>
                    {{ form.ups }}
                </div>
            </div>

            <!-- User input fields -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="id_po_number" class="form-label">PO Number</label>
                    {{ form.po_number }}
                </div>
                <div class="col-md-6">
                    <label for="id_po_quantity" class="form-label">PO Quantity</label>
                    {{ form.po_quantity }}
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="id_unit_cost" class="form-label">Unit Cost</label>
                    {{ form.unit_cost }}
                </div>
                <div class="col-md-6">
                    <label for="id_stock" class="form-label">Stock</label>
                    {{ form.stock }}
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="id_wastage" class="form-label">Wastage</label>
                    {{ form.wastage }}
                </div>
                <div class="col-md-6">
                    <label for="id_customer_name" class="form-label">Customer Name</label>
                    {{ form.customer_name }}
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label for="id_notes" class="form-label">Notes</label>
                    {{ form.notes }}
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="id_po_date" class="form-label">PO Date</label>
                    {{ form.po_date }}
                </div>
                <div class="col-md-6">
                    <label for="id_planned_date" class="form-label">Planned Date</label>
                    {{ form.planned_date }}
                </div>
            </div>

            <button type="submit" class="btn btn-success w-100 btn-custom">Save Job</button>
        </form>
    </div>
</div>

<!-- Bootstrap JS & jQuery -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
    // Function to generate JC# based on the last job number
    const generateJobCode = () => {
        const currentMonth = new Date().getMonth() + 1; // Get current month
        const currentYear = new Date().getFullYear(); // Get current year
        const monthYear = currentMonth + "-" + currentYear; // Format: month-year

        $.ajax({
            url: "{% url 'get_last_job_code' %}",  // Fetch the last job created for this month
            method: "GET",
            data: {
                "month_year": monthYear
            },
            success: function(response) {
                let lastJobCode = response.last_job_code;
                let newJobNumber = 1; // Default to 1 if no jobs exist for the month

                if (lastJobCode) {
                    // Extract the number from last JC# and increment it
                    let lastJobNumber = parseInt(lastJobCode.split("-")[3]);
                    newJobNumber = lastJobNumber + 1; // Increment by 1
                }

                // Format the new JC#
                const newJobCode = "JC-" + monthYear + "-" + String(newJobNumber).padStart(4, '0');
                $("#id_job_name").val(newJobCode); // Display the JC# in the form field
                $("#hidden_job_name").val(newJobCode); // Set the hidden field value to the generated JC#
            },
            error: function() {
                alert("Error fetching last job code.");
            }
        });
    };

    // Generate JC# on page load
    generateJobCode();

    // Trigger AJAX call when SKU is entered
    $("#id_sku").on('change', function() {
        var sku = $(this).val();  // Get the SKU value
        if (sku) {
            $.ajax({
                url: "{% url 'fetch_recipe' %}",
                data: {'sku': sku},  // Send SKU as a GET parameter
                dataType: 'json',
                success: function(response) {
                    if (response.error) {
                        alert(response.error);  // Show error if recipe not found
                    } else {
                        // Populate the fields with fetched recipe data
                        $("#id_sku_code").val(response.sku_code);  // Set SKU code in sku_code field
                        $("#id_material_type").val(response.material_type);  // Set material type
                        $("#id_application_type").val(response.application_type);  // Set application type
                        $("#id_one_up_width").val(response.one_up_width);  // Set one-up width
                        $("#id_one_up_height").val(response.one_up_height);  // Set one-up height
                        $("#id_print_sheet_width").val(response.print_sheet_width);  // Set print sheet width
                        $("#id_print_sheet_height").val(response.print_sheet_height);  // Set print sheet height
                        $("#id_print_sheet_size").val(response.print_sheet_size);  // Set print sheet size
                        $("#id_ups").val(response.ups);  // Set UPS
                        $("#id_purchase_sheet_width").val(response.purchase_sheet_width);  // Set purchase sheet width
                        $("#id_purchase_sheet_height").val(response.purchase_sheet_height);  // Set purchase sheet height
                        $("#id_purchase_sheet_size").val(response.purchase_sheet_size);  // Set purchase sheet size
                        $("#id_purchase_ups").val(response.purchase_ups);  // Set purchase UPS
                    }
                },
                error: function() {
                    alert("Error fetching recipe.");
                }
            });
        }
    });
});
</script>

</body>
</html>
